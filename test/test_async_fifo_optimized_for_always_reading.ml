open Core

module Test (Logic : Hardcaml_event_driven_sim.Logic.S) = struct
  let data_width = 8

  module M = Hardcaml.Async_fifo.Make (struct
      let width = data_width
      let log2_depth = 2
      let optimize_for_same_clock_rate_and_always_reading = true
    end)

  module I = M.I
  module O = M.O

  let reader_writer_test
    ?(half_period = 1)
    ?(print_waves = false)
    ?use_negedge_sync_chain
    ?time_limit
    ?(stop_writing_at = Int.max_value)
    ?(read_clock_skew = 0)
    ?(raise_on_output_error = true)
    ?(reader_glitch_at = Int.Set.empty)
    ?(reader_glitch_length = 1)
    ?(probability_write_enable = 1.0)
    ?(display_width = 90)
    ()
    =
    if read_clock_skew < 0
    then
      raise_s
        [%message
          "read_clock_skew should be a non-negative value" (read_clock_skew : int)];
    let time_limit =
      match time_limit with
      | None -> 50 * half_period
      | Some x -> x
    in
    let module Sim = Event_driven_sim.Simulator in
    let module Sim_interface = Hardcaml_event_driven_sim.With_interface (Logic) (I) (O) in
    let open Sim in
    let open Async in
    let open Logic in
    let fifo =
      M.create
        ?use_negedge_sync_chain
        ~scope:(Hardcaml.Scope.create ~flatten_design:true ())
    in
    let q_read = Queue.create () in
    let q_write = Queue.create () in
    let waves, { Sim_interface.simulator = sim; _ } =
      Sim_interface.with_waveterm
        ~config:Hardcaml_event_driven_sim.Config.trace_all
        fifo
        (fun input output ->
           let input = I.map input ~f:(fun v -> v.signal) in
           let output = O.map output ~f:(fun v -> v.signal) in
           [ create_process (fun () ->
               forever (fun () ->
                 let%bind () = delay half_period in
                 input.I.clock_write <-- of_string "1";
                 let%map () = delay half_period in
                 input.I.clock_write <-- of_string "0"))
           ; create_process (fun () ->
               let delay_maybe_glitch dt =
                 if Set.mem reader_glitch_at (current_time ())
                 then delay (dt + reader_glitch_length)
                 else delay dt
               in
               let%bind () = delay read_clock_skew in
               forever (fun () ->
                 let%bind () = delay_maybe_glitch half_period in
                 input.I.clock_read <-- of_string "1";
                 let%map () = delay_maybe_glitch half_period in
                 input.I.clock_read <-- of_string "0"))
           ; Sim.Process.create [ !&(input.I.clock_write) ] (fun () ->
               if not (to_bool !!(input.I.clock_write))
               then
                 if current_time () >= stop_writing_at
                    || Float.(Random.float 1.0 > probability_write_enable)
                 then input.I.write_enable <-- of_string "0"
                 else (
                   input.I.write_enable <-- of_string "1";
                   let data = Random.int (1 lsl data_width) in
                   Queue.enqueue q_write data;
                   input.I.data_in <-- Logic.of_int_trunc ~width:data_width data))
           ; Sim.Process.create [ !&(input.I.clock_read) ] (fun () ->
               if (not (to_bool !!(input.I.clock_read))) && to_bool !!(output.O.valid)
               then Queue.enqueue q_read (Logic.to_int_trunc !!(output.O.data_out)))
           ])
    in
    Sim.run ~time_limit sim;
    let result =
      if [%equal: int Queue.t] q_write q_read
      then (
        let num_elements = Queue.length q_write in
        Ok
          (sprintf
             "Validated that %d elements written and read all matches!\n"
             num_elements))
      else
        Or_error.error_s
          [%message
            "WRITE AND READ ELEMENTS DO NOT MATCH!"
              (q_write : int Queue.t)
              (q_read : int Queue.t)]
    in
    if raise_on_output_error then Or_error.iter_error ~f:Error.raise result;
    print_s ([%sexp_of: string Or_error.t] result);
    if print_waves
    then
      let open Hardcaml_waveterm_kernel in
      let display_rules =
        Display_rule.
          [ port_name_is "clock_read" ~wave_format:Bit
          ; port_name_is "clock_write" ~wave_format:Bit
          ; port_name_is ~alignment:Right "data_in" ~wave_format:Hex
          ; port_name_is ~alignment:Right "write_enable" ~wave_format:Bit
          ; port_name_is ~alignment:Right "data_out" ~wave_format:Hex
          ; port_name_is ~alignment:Right "valid" ~wave_format:Bit
          ; port_name_is ~alignment:Right "raddr_rd" ~wave_format:Hex
          ; port_name_is ~alignment:Right "waddr_wd" ~wave_format:Hex
          ; port_name_is ~alignment:Right "waddr_rd_ff_0" ~wave_format:Hex
          ; port_name_is ~alignment:Right "waddr_rd" ~wave_format:Hex
          ]
      in
      Hardcaml_event_driven_sim.Waveterm.Waveform.expect
        waves
        ~display_rules
        ~wave_width:0
        ~display_width
  ;;

  let%expect_test "Line rate at even number clock skew" =
    reader_writer_test
      ~print_waves:true
      ~read_clock_skew:4
      ~time_limit:35
      ~stop_writing_at:25
      ();
    [%expect
      {|
      (Ok "Validated that 13 elements written and read all matches!\n")
      ┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────┐
      │clock_read        ││          ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─│
      │                  ││──────────┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ │
      │clock_write       ││  ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─│
      │                  ││──┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ │
      │                  ││────┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───────────────────│
      │data_in           ││ 65 │0F │61 │8C │2A │3F │A0 │C8 │B2 │66 │02 │5C │21                 │
      │                  ││────┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───────────────────│
      │write_enable      ││────────────────────────────────────────────────────┐               │
      │                  ││                                                    └───────────────│
      │                  ││──────────┬───────┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬─│
      │data_out          ││ 00       │65     │0F │61 │8C │2A │3F │A0 │C8 │B2 │66 │02 │5C │21 │.│
      │                  ││──────────┴───────┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴─│
      │valid             ││              ┌───────────────────────────────────────────────────┐ │
      │                  ││──────────────┘                                                   └─│
      │                  ││──────────────────┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬─│
      │raddr_rd          ││ 0                │1  │3  │2  │0  │1  │3  │2  │0  │1  │3  │2  │0  │1│
      │                  ││──────────────────┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴─│
      │                  ││──┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬─────────────────│
      │waddr_wd          ││ 0│1  │3  │2  │0  │1  │3  │2  │0  │1  │3  │2  │0  │1                │
      │                  ││──┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴─────────────────│
      │                  ││──────────┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬─────────────│
      │waddr_rd_ff_0     ││ 0        │3  │2  │0  │1  │3  │2  │0  │1  │3  │2  │0  │1            │
      │                  ││──────────┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴─────────────│
      │                  ││──────────────┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬─────────│
      │waddr_rd          ││ 0            │3  │2  │0  │1  │3  │2  │0  │1  │3  │2  │0  │1        │
      │                  ││──────────────┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴─────────│
      └──────────────────┘└────────────────────────────────────────────────────────────────────┘
      59624e49ff83a2a6806539568ab58c6a
      |}]
  ;;

  let%expect_test "Line rate at odd number clock skew" =
    reader_writer_test
      ~print_waves:true
      ~read_clock_skew:3
      ~time_limit:35
      ~stop_writing_at:25
      ();
    [%expect
      {|
      (Ok "Validated that 13 elements written and read all matches!\n")
      ┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────┐
      │clock_read        ││        ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ │
      │                  ││────────┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─│
      │clock_write       ││  ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─│
      │                  ││──┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ │
      │                  ││────┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───────────────────│
      │data_in           ││ 65 │0F │61 │8C │2A │3F │A0 │C8 │B2 │66 │02 │5C │21                 │
      │                  ││────┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───────────────────│
      │write_enable      ││────────────────────────────────────────────────────┐               │
      │                  ││                                                    └───────────────│
      │                  ││────────┬───────┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───│
      │data_out          ││ 00     │65     │0F │61 │8C │2A │3F │A0 │C8 │B2 │66 │02 │5C │21 │66 │
      │                  ││────────┴───────┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───│
      │valid             ││            ┌───────────────────────────────────────────────────┐   │
      │                  ││────────────┘                                                   └───│
      │                  ││────────────────┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───│
      │raddr_rd          ││ 0              │1  │3  │2  │0  │1  │3  │2  │0  │1  │3  │2  │0  │1  │
      │                  ││────────────────┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───│
      │                  ││──┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬─────────────────│
      │waddr_wd          ││ 0│1  │3  │2  │0  │1  │3  │2  │0  │1  │3  │2  │0  │1                │
      │                  ││──┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴─────────────────│
      │                  ││────────┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───────────────│
      │waddr_rd_ff_0     ││ 0      │3  │2  │0  │1  │3  │2  │0  │1  │3  │2  │0  │1              │
      │                  ││────────┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───────────────│
      │                  ││────────────┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───────────│
      │waddr_rd          ││ 0          │3  │2  │0  │1  │3  │2  │0  │1  │3  │2  │0  │1          │
      │                  ││────────────┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───────────│
      └──────────────────┘└────────────────────────────────────────────────────────────────────┘
      8b04669f599ff2b828a56670a60d8bb5
      |}]
  ;;

  let%expect_test "Tolerate some amount of glitch with line-rate data" =
    reader_writer_test
      ~reader_glitch_at:(Int.Set.of_list [ 9 ])
      ~reader_glitch_length:5
      ~print_waves:true
      ~read_clock_skew:1
      ~time_limit:35
      ~stop_writing_at:25
      ();
    [%expect
      {|
      (Ok "Validated that 13 elements written and read all matches!\n")
      ┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────┐
      │clock_read        ││    ┌─┐ ┌─┐ ┌─┐ ┌─┐           ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─│
      │                  ││────┘ └─┘ └─┘ └─┘ └───────────┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ │
      │clock_write       ││  ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─│
      │                  ││──┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ │
      │                  ││────┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───────────────────│
      │data_in           ││ 65 │0F │61 │8C │2A │3F │A0 │C8 │B2 │66 │02 │5C │21                 │
      │                  ││────┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───────────────────│
      │write_enable      ││────────────────────────────────────────────────────┐               │
      │                  ││                                                    └───────────────│
      │                  ││────┬───────┬───┬─────────────┬───┬───┬───┬───┬───┬───┬───┬───┬───┬─│
      │data_out          ││ 00 │65     │0F │61           │8C │2A │3F │A0 │C8 │B2 │66 │02 │5C │.│
      │                  ││────┴───────┴───┴─────────────┴───┴───┴───┴───┴───┴───┴───┴───┴───┴─│
      │valid             ││        ┌───────────────────────────────────────────────────────────│
      │                  ││────────┘                                                           │
      │                  ││────────────┬───┬─────────────┬───┬───┬───┬───┬───┬───┬───┬───┬───┬─│
      │raddr_rd          ││ 0          │1  │3            │2  │0  │1  │3  │2  │0  │1  │3  │2  │0│
      │                  ││────────────┴───┴─────────────┴───┴───┴───┴───┴───┴───┴───┴───┴───┴─│
      │                  ││──┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬─────────────────│
      │waddr_wd          ││ 0│1  │3  │2  │0  │1  │3  │2  │0  │1  │3  │2  │0  │1                │
      │                  ││──┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴─────────────────│
      │                  ││────┬───┬───┬───┬─────────────┬───┬───┬───┬───┬───┬───┬─────────────│
      │waddr_rd_ff_0     ││ 0  │1  │3  │2  │0            │2  │0  │1  │3  │2  │0  │1            │
      │                  ││────┴───┴───┴───┴─────────────┴───┴───┴───┴───┴───┴───┴─────────────│
      │                  ││────────┬───┬───┬─────────────┬───┬───┬───┬───┬───┬───┬───┬─────────│
      │waddr_rd          ││ 0      │1  │3  │2            │0  │2  │0  │1  │3  │2  │0  │1        │
      │                  ││────────┴───┴───┴─────────────┴───┴───┴───┴───┴───┴───┴───┴─────────│
      └──────────────────┘└────────────────────────────────────────────────────────────────────┘
      804b5c10649b091aec4a772e6fe68409
      |}];
    reader_writer_test
      ~reader_glitch_at:(Int.Set.of_list [ 10 ])
      ~reader_glitch_length:5
      ~print_waves:true
      ~read_clock_skew:1
      ~time_limit:35
      ~stop_writing_at:25
      ();
    [%expect
      {|
      (Ok "Validated that 13 elements written and read all matches!\n")
      ┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────┐
      │clock_read        ││    ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌───────────┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─│
      │                  ││────┘ └─┘ └─┘ └─┘ └─┘           └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ │
      │clock_write       ││  ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─│
      │                  ││──┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ │
      │                  ││────┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───────────────────│
      │data_in           ││ 05 │0F │31 │76 │A0 │00 │06 │3C │8F │0B │86 │EE │A1                 │
      │                  ││────┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───────────────────│
      │write_enable      ││────────────────────────────────────────────────────┐               │
      │                  ││                                                    └───────────────│
      │                  ││────┬───────┬───┬───┬─────────────┬───┬───┬───┬───┬───┬───┬───┬───┬─│
      │data_out          ││ 00 │05     │0F │31 │76           │A0 │00 │06 │3C │8F │0B │86 │EE │.│
      │                  ││────┴───────┴───┴───┴─────────────┴───┴───┴───┴───┴───┴───┴───┴───┴─│
      │valid             ││        ┌───────────────────────────────────────────────────────────│
      │                  ││────────┘                                                           │
      │                  ││────────────┬───┬───┬─────────────┬───┬───┬───┬───┬───┬───┬───┬───┬─│
      │raddr_rd          ││ 0          │1  │3  │2            │0  │1  │3  │2  │0  │1  │3  │2  │0│
      │                  ││────────────┴───┴───┴─────────────┴───┴───┴───┴───┴───┴───┴───┴───┴─│
      │                  ││──┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬─────────────────│
      │waddr_wd          ││ 0│1  │3  │2  │0  │1  │3  │2  │0  │1  │3  │2  │0  │1                │
      │                  ││──┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴─────────────────│
      │                  ││────┬───┬───┬───┬───┬─────────────┬───┬───┬───┬───┬───┬─────────────│
      │waddr_rd_ff_0     ││ 0  │1  │3  │2  │0  │1            │0  │1  │3  │2  │0  │1            │
      │                  ││────┴───┴───┴───┴───┴─────────────┴───┴───┴───┴───┴───┴─────────────│
      │                  ││────────┬───┬───┬───┬─────────────┬───┬───┬───┬───┬───┬───┬─────────│
      │waddr_rd          ││ 0      │1  │3  │2  │0            │1  │0  │1  │3  │2  │0  │1        │
      │                  ││────────┴───┴───┴───┴─────────────┴───┴───┴───┴───┴───┴───┴─────────│
      └──────────────────┘└────────────────────────────────────────────────────────────────────┘
      026d06694cf8408ffefecc9ad14c1c1c
      |}];
    (* write and read clock are offset by a fraction of a half cycle. *)
    reader_writer_test
      ~reader_glitch_at:(Int.Set.of_list [ 9 ])
      ~reader_glitch_length:1
      ~half_period:2
      ~print_waves:true
      ~read_clock_skew:1
      ~time_limit:35
      ~stop_writing_at:25
      ();
    [%expect
      {|
      (Ok "Validated that 7 elements written and read all matches!\n")
      ┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────┐
      │clock_read        ││      ┌───┐   ┌───┐     ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───│
      │                  ││──────┘   └───┘   └─────┘   └───┘   └───┘   └───┘   └───┘   └───┘   │
      │clock_write       ││    ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   │
      │                  ││────┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───│
      │                  ││────────┬───────┬───────┬───────┬───────┬───────┬───────────────────│
      │data_in           ││ EF     │78     │EA     │2C     │9E     │08     │53                 │
      │                  ││────────┴───────┴───────┴───────┴───────┴───────┴───────────────────│
      │write_enable      ││────────────────────────────────────────────────────────┐           │
      │                  ││                                                        └───────────│
      │                  ││──────┬─────────────────┬───────┬───────┬───────┬───────┬───────┬───│
      │data_out          ││ 00   │EF               │78     │EA     │2C     │9E     │08     │53 │
      │                  ││──────┴─────────────────┴───────┴───────┴───────┴───────┴───────┴───│
      │valid             ││              ┌─────────────────────────────────────────────────────│
      │                  ││──────────────┘                                                     │
      │                  ││────────────────────────┬───────┬───────┬───────┬───────┬───────┬───│
      │raddr_rd          ││ 0                      │1      │3      │2      │0      │1      │3  │
      │                  ││────────────────────────┴───────┴───────┴───────┴───────┴───────┴───│
      │                  ││────┬───────┬───────┬───────┬───────┬───────┬───────┬───────────────│
      │waddr_wd          ││ 0  │1      │3      │2      │0      │1      │3      │2              │
      │                  ││────┴───────┴───────┴───────┴───────┴───────┴───────┴───────────────│
      │                  ││──────┬───────┬─────────┬───────┬───────┬───────┬───────┬───────────│
      │waddr_rd_ff_0     ││ 0    │1      │3        │2      │0      │1      │3      │2          │
      │                  ││──────┴───────┴─────────┴───────┴───────┴───────┴───────┴───────────│
      │                  ││──────────────┬─────────┬───────┬───────┬───────┬───────┬───────┬───│
      │waddr_rd          ││ 0            │1        │3      │2      │0      │1      │3      │2  │
      │                  ││──────────────┴─────────┴───────┴───────┴───────┴───────┴───────┴───│
      └──────────────────┘└────────────────────────────────────────────────────────────────────┘
      6558648e0908db25850c15743e7b25aa
      |}]
  ;;

  let%expect_test "Fails if glitch for too long in line-rate data" =
    reader_writer_test
      ~raise_on_output_error:false
      ~reader_glitch_at:(Int.Set.of_list [ 9 ])
      ~reader_glitch_length:6
      ~print_waves:true
      ~read_clock_skew:1
      ~stop_writing_at:25
      ~display_width:100
      ();
    [%expect
      {|
      (Error
       ("WRITE AND READ ELEMENTS DO NOT MATCH!"
        (q_write (101 15 97 140 42 63 160 200 178 102 2 92 33))
        (q_read (101 15 97 200 178 102 2 92 33))))
      ┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────┐
      │clock_read        ││    ┌─┐ ┌─┐ ┌─┐ ┌─┐             ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─│
      │                  ││────┘ └─┘ └─┘ └─┘ └─────────────┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ │
      │clock_write       ││  ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ │
      │                  ││──┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─│
      │                  ││────┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬─────────────────────────────│
      │data_in           ││ 65 │0F │61 │8C │2A │3F │A0 │C8 │B2 │66 │02 │5C │21                           │
      │                  ││────┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴─────────────────────────────│
      │write_enable      ││────────────────────────────────────────────────────┐                         │
      │                  ││                                                    └─────────────────────────│
      │                  ││────┬───────┬───┬───────────────┬───┬───────┬───┬───┬───┬───┬─────────────────│
      │data_out          ││ 00 │65     │0F │61             │C8 │B2     │66 │02 │5C │21 │66               │
      │                  ││────┴───────┴───┴───────────────┴───┴───────┴───┴───┴───┴───┴─────────────────│
      │valid             ││        ┌───────────────────────────┐   ┌───────────────────┐                 │
      │                  ││────────┘                           └───┘                   └─────────────────│
      │                  ││────────────┬───┬───────────────┬───┬───────┬───┬───┬───┬───┬─────────────────│
      │raddr_rd          ││ 0          │1  │3              │2  │0      │1  │3  │2  │0  │1                │
      │                  ││────────────┴───┴───────────────┴───┴───────┴───┴───┴───┴───┴─────────────────│
      │                  ││──┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───────────────────────────│
      │waddr_wd          ││ 0│1  │3  │2  │0  │1  │3  │2  │0  │1  │3  │2  │0  │1                          │
      │                  ││──┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───────────────────────────│
      │                  ││────┬───┬───┬───┬───────────────────┬───┬───┬───┬───┬─────────────────────────│
      │waddr_rd_ff_0     ││ 0  │1  │3  │2  │0                  │1  │3  │2  │0  │1                        │
      │                  ││────┴───┴───┴───┴───────────────────┴───┴───┴───┴───┴─────────────────────────│
      │                  ││────────┬───┬───┬───────────────┬───────┬───┬───┬───┬───┬─────────────────────│
      │waddr_rd          ││ 0      │1  │3  │2              │0      │1  │3  │2  │0  │1                    │
      │                  ││────────┴───┴───┴───────────────┴───────┴───┴───┴───┴───┴─────────────────────│
      └──────────────────┘└──────────────────────────────────────────────────────────────────────────────┘
      6a8e2714cda3b5390436343e55c90ad4
      |}];
    reader_writer_test
      ~raise_on_output_error:false
      ~reader_glitch_at:(Int.Set.of_list [ 9 ])
      ~reader_glitch_length:12
      ~half_period:2
      ~print_waves:true
      ~read_clock_skew:1
      ~stop_writing_at:25
      ~display_width:100
      ();
    [%expect
      {|
      (Error
       ("WRITE AND READ ELEMENTS DO NOT MATCH!" (q_write (5 15 49 118 160 0 6))
        (q_read (5 0 6))))
      ┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────┐
      │clock_read        ││      ┌───┐   ┌───┐                           ┌───┐   ┌───┐   ┌───┐   ┌───┐   │
      │                  ││──────┘   └───┘   └───────────────────────────┘   └───┘   └───┘   └───┘   └───│
      │clock_write       ││    ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌─│
      │                  ││────┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘ │
      │                  ││────────┬───────┬───────┬───────┬───────┬───────┬─────────────────────────────│
      │data_in           ││ 05     │0F     │31     │76     │A0     │00     │06                           │
      │                  ││────────┴───────┴───────┴───────┴───────┴───────┴─────────────────────────────│
      │write_enable      ││────────────────────────────────────────────────────────┐                     │
      │                  ││                                                        └─────────────────────│
      │                  ││──────┬───────────────────────────────────────┬───────┬───────────────┬───────│
      │data_out          ││ 00   │05                                     │00     │06             │76     │
      │                  ││──────┴───────────────────────────────────────┴───────┴───────────────┴───────│
      │valid             ││              ┌───────────────────────────────────────┐       ┌───────┐       │
      │                  ││──────────────┘                                       └───────┘       └───────│
      │                  ││──────────────────────────────────────────────┬───────┬───────────────┬───────│
      │raddr_rd          ││ 0                                            │1      │3              │2      │
      │                  ││──────────────────────────────────────────────┴───────┴───────────────┴───────│
      │                  ││────┬───────┬───────┬───────┬───────┬───────┬───────┬─────────────────────────│
      │waddr_wd          ││ 0  │1      │3      │2      │0      │1      │3      │2                        │
      │                  ││────┴───────┴───────┴───────┴───────┴───────┴───────┴─────────────────────────│
      │                  ││──────┬───────┬───────────────────────────────────────┬───────────────────────│
      │waddr_rd_ff_0     ││ 0    │1      │3                                      │2                      │
      │                  ││──────┴───────┴───────────────────────────────────────┴───────────────────────│
      │                  ││──────────────┬───────────────────────────────┬───────────────┬───────────────│
      │waddr_rd          ││ 0            │1                              │3              │2              │
      │                  ││──────────────┴───────────────────────────────┴───────────────┴───────────────│
      └──────────────────┘└──────────────────────────────────────────────────────────────────────────────┘
      b3f81040823b46e0e5797ba1af0c1c60
      |}]
  ;;

  let%expect_test "Appropriately deasserts [valid] with none line-rate data" =
    reader_writer_test
      ~print_waves:true
      ~read_clock_skew:1
      ~time_limit:35
      ~stop_writing_at:25
      ~probability_write_enable:0.8
      ();
    [%expect
      {|
      (Ok "Validated that 9 elements written and read all matches!\n")
      ┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────┐
      │clock_read        ││    ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ │
      │                  ││────┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─│
      │clock_write       ││  ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─│
      │                  ││──┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ │
      │                  ││────┬───┬───────────┬───┬───┬───┬───┬───────────┬───────────────────│
      │data_in           ││ 65 │0F │61         │3D │62 │6F │68 │31         │E9                 │
      │                  ││────┴───┴───────────┴───┴───┴───┴───┴───────────┴───────────────────│
      │write_enable      ││────────────┐       ┌───────────────────┐       ┌───┐               │
      │                  ││            └───────┘                   └───────┘   └───────────────│
      │                  ││────┬───────┬───┬───┬───┬───────┬───┬───┬───┬───┬───┬───────┬───────│
      │data_out          ││ 00 │65     │0F │61 │00 │3D     │62 │6F │68 │31 │62 │E9     │6F     │
      │                  ││────┴───────┴───┴───┴───┴───────┴───┴───┴───┴───┴───┴───────┴───────│
      │valid             ││        ┌───────────┐       ┌───────────────────┐       ┌───┐       │
      │                  ││────────┘           └───────┘                   └───────┘   └───────│
      │                  ││────────────┬───┬───┬───────────┬───┬───┬───┬───┬───────────┬───────│
      │raddr_rd          ││ 0          │1  │3  │2          │0  │1  │3  │2  │0          │1      │
      │                  ││────────────┴───┴───┴───────────┴───┴───┴───┴───┴───────────┴───────│
      │                  ││──┬───┬───┬───────────┬───┬───┬───┬───┬───────────┬─────────────────│
      │waddr_wd          ││ 0│1  │3  │2          │0  │1  │3  │2  │0          │1                │
      │                  ││──┴───┴───┴───────────┴───┴───┴───┴───┴───────────┴─────────────────│
      │                  ││────┬───┬───┬───────────┬───┬───┬───┬───┬───────────┬───────────────│
      │waddr_rd_ff_0     ││ 0  │1  │3  │2          │0  │1  │3  │2  │0          │1              │
      │                  ││────┴───┴───┴───────────┴───┴───┴───┴───┴───────────┴───────────────│
      │                  ││────────┬───┬───┬───────────┬───┬───┬───┬───┬───────────┬───────────│
      │waddr_rd          ││ 0      │1  │3  │2          │0  │1  │3  │2  │0          │1          │
      │                  ││────────┴───┴───┴───────────┴───┴───┴───┴───┴───────────┴───────────│
      └──────────────────┘└────────────────────────────────────────────────────────────────────┘
      fdaeeb28ed534bd74a0c1d480b2018f2
      |}]
  ;;
end

module%test With_four_state_logic = Test (Hardcaml_event_driven_sim.Four_state_logic)
module%test With_two_state_logic = Test (Hardcaml_event_driven_sim.Two_state_logic)
